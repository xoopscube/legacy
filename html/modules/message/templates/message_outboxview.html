<{* set tab sent-box to active *}>
<{assign var="outboxView" value="ui-tabs-active ui-state-active"}>

<{* Dev-Mode Toggle *}>
<{if $xoops_isadmin}><div class="ui-dev-mode"><{$smarty.template}></div><{/if}>

<nav aria-label="breadcrumb">
<ul>
    <li><a href="<{$xoops_url}>/"><img class="svg" src="<{$xoops_url}>/images/icons/home.svg" width="1em" height="1em" alt="home"></a></li>
    <li><a href="index.php"><img class="svg" src="<{$xoops_url}>/images/icons/inbox-out.svg" width="1em" height="1em" alt="outbox"> <span data-self="sm-hide"><{$smarty.const._MI_MESSAGE_NAME}></span></a></li>
    <li><a href="index.php?action=send"><{$smarty.const._MD_MESSAGE_TEMPLATE7}></a></li>
    <li aria-current="<{$smarty.const._MD_MESSAGE_TEMPLATE4}>"><{$smarty.const._MD_MESSAGE_TEMPLATE4}></li>
</ul>
</nav>


<article id="mail-outbox-view">

    <header>
        <{include file=db:message_nav.html}>
    </header>

    <div id="printhis">

        <div class="headings">

        <div class="mail-body">
        <h3 class="mail-subject" aria-label="<{$smarty.const._MD_MESSAGE_TEMPLATE3}>"><{$msgdata.title}></h3>
            <div class="flex-justify">
                <div class="mail-to" aria-label="<{$smarty.const._MD_MESSAGE_TEMPLATE4}>">
                    <{$smarty.const._MD_MESSAGE_TEMPLATE9}> <img src="<{$msgdata.to_uid|xoops_user_avatarize}>" width="24px" data-self="radius-circle" alt="avatar">
                    <{$msgdata.toname}>
                </div>
                <div class="mail-date" aria-label="<{$smarty.const._MD_MESSAGE_TEMPLATE10}>">
                    <img class="svg datetime" src="<{$xoops_url}>/images/icons/datetime.svg" alt="datetime"> <span class="badge"><{$msgdata.utime|xoops_formattimestamp:l}></span>
                </div>
            </div>
        </div>
        <hr>

        <div class="mail-content" aria-label="<{$smarty.const._MD_MESSAGE_TEMPLATE4}>">
            <{$msgdata.message}>
        </div>

        </div>

    </div><{* printhis *}>

    <hr>

    <footer class="action-control">
        <form id="message-delete" method="post" action="index.php?action=delete&amp;inout=out">
            <{* token implementation by providing name and value parameters *}>
            <{xoops_token name="outboxview_token" value="1"}>
            <input type="hidden" name="outbox" value="<{$msgdata.outbox_id}>">
            <button type="submit" role="button" class="outline secondary delete" value="<{$smarty.const._MD_MESSAGE_TEMPLATE14}>">
                <img class="svg delete" src="<{$xoops_url}>/images/icons/delete.svg" alt="delete"> <{$smarty.const._MD_MESSAGE_TEMPLATE14}>
            </button>
            <span id="delete-status"></span>
       </form>
       
       <span id="msg-nav">
           <{if $msgdata.prev_id}>
           <a href="#" onclick="loadMessage('<{$msgdata.prev_id}>', '<{$msgdata.param}>', '<{$msgdata.inout_short}>'); return false;" class="outline">&laquo; Previous</a>
           <{/if}>
           <{if $msgdata.next_id}>
           <a href="#" onclick="loadMessage('<{$msgdata.next_id}>', '<{$msgdata.param}>', '<{$msgdata.inout_short}>'); return false;" class="outline">Next &raquo;</a>
           <{/if}>
       </span>
    </footer>
</article>

<{* Add JavaScript for ajax *}>
<script type="text/javascript">
  function loadMessage(id, param, inout) {

      fetch('index.php?action=view&' + param + '=' + id + '&inout=' + inout + '&ajax=1')
          .then(response => response.json())
          .then(data => {
              if (data.error) {
                  alert(data.error);
                  return;
              }
              
              // Update message content
              document.querySelector('.mail-subject').innerHTML = data.subject;
              
              // Update recipient with avatar
              const toElement = document.querySelector('.mail-to');
              if (toElement) {
                  // Use the avatar_url from the response
                  toElement.innerHTML = '<{$smarty.const._MD_MESSAGE_TEMPLATE9}> ' + 
                      '<img src="' + (data.avatar_url || '<{$xoops_url}>/modules/user/images/no_avatar.gif') + 
                      '" width="24px" data-self="radius-circle" alt="avatar"> ' + 
                      data.to;
              }
              
              document.querySelector('.mail-content').innerHTML = data.body;
              document.querySelector('.mail-date').innerHTML = 
                  '<img class="svg datetime" src="<{$xoops_url}>/images/icons/datetime.svg" alt="datetime"> ' + 
                  '<span class="badge">' + data.date + '</span>';
              
              // Update form values for delete form
              document.querySelectorAll('input[name="outbox"]').forEach(input => {
                  input.value = id;
              });
              
              // Update navigation buttons
              let navHtml = '';
              if (data.prev_id) {
                  navHtml += `<a href="#" onclick="loadMessage('${data.prev_id}', '${data.param}', '${data.inout_short}'); return false;" class="outline">&laquo; Previous</a> `;
              }
              if (data.next_id) {
                  navHtml += `<a href="#" onclick="loadMessage('${data.next_id}', '${data.param}', '${data.inout_short}'); return false;" class="outline">Next &raquo;</a>`;
              }
              document.getElementById('msg-nav').innerHTML = navHtml;
              
              // Update URL without reloading
              history.pushState({}, '', 'index.php?action=view&' + param + '=' + id + '&inout=' + inout);
          })
          .catch(error => {
              console.error('Error loading message:', error);
              alert('Error loading message. Please try again.');
          });
  }
  
  // AJAX delete functionality
  document.addEventListener('DOMContentLoaded', function() {
      const deleteForm = document.getElementById('message-delete');
      const deleteStatus = document.getElementById('delete-status');
      
      if (deleteForm) {
          deleteForm.addEventListener('submit', function(event) {
              event.preventDefault();
              
              // Get the message ID from the form
              const messageId = deleteForm.querySelector('input[name="outbox"]').value;
              const inout = 'out'; // For outbox view
              
              // Show deleting status
              if (deleteStatus) deleteStatus.textContent = 'Deleting...';
              
            // Create FormData from the form
            // this automatically includes all fields including the token
            const formData = new FormData(deleteForm);
            const searchParams = new URLSearchParams(formData);

              // Send AJAX request
              fetch('index.php?action=delete&inout=' + inout + '&ajax=1', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: searchParams.toString(),
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      // Success - redirect to outbox
                      if (deleteStatus) deleteStatus.textContent = data.message || 'Message deleted successfully.';
                      
                      // Redirect to outbox after a short delay
                      setTimeout(function() {
                          window.location.href = 'index.php?action=send';
                      }, 500); // Reduced delay for better UX
                  } else {
                      // Error
                      if (deleteStatus) deleteStatus.textContent = data.error || 'Error deleting message.';
                      console.error('Delete error:', data);
                  }
              })
              .catch(error => {
                  console.error('Network error:', error);
                  if (deleteStatus) deleteStatus.textContent = 'Network error. Please try again.';
              });
          });
      }
  });
</script>
