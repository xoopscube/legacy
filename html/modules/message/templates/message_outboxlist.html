<{* Dev-Mode Toggle *}>
<{if $xoops_isadmin}><div class="ui-dev-mode"><{$smarty.template}></div><{/if}>

<nav aria-label="breadcrumb">
<ul>
    <li><a href="<{$xoops_url}>/"><img class="svg" src="<{$xoops_url}>/images/icons/home.svg" width="1em" height="1em" alt="home"></a></li>
    <li><a href="index.php"><img class="svg" src="<{$xoops_url}>/images/icons/inbox.svg" width="1em" height="1em" alt="inbox"> <span data-self="sm-hide"><{$smarty.const._MI_MESSAGE_NAME}></span></a></li>
    <li aria-current="page"><{$smarty.const._MD_MESSAGE_TEMPLATE7}></li>
</ul>
</nav>


<article id="mail-outbox-list">

    <header>
        <{include file=db:message_nav.html}>
    </header>

    <form method="post" action="index.php?action=send">
        <!-- Search form content -->
        <div class="grid">
            <select name="touid">
                <option value="0">-<{$smarty.const._MD_MESSAGE_TEMPLATE9}></option>
                <{foreach item=fuser from=$select}>
                <option value="<{$fuser.uid}>"<{if $fuser.select==true}> selected="selected"<{/if}>><{$fuser.uname|xoops_escape}></option>
                <{/foreach}>
            </select>
            <input type="text" name="subject" size="25" value="<{$subject|xoops_escape}>" placeholder="<{$smarty.const._MD_MESSAGE_TEMPLATE3}>">
            <button type="submit" class="outline" role="button" name="subbtn" value="<{$smarty.const._MD_MESSAGE_SEARCH}>">
                <img class="svg search" src="<{$xoops_url}>/images/icons/search.svg"> <{$smarty.const._MD_MESSAGE_SEARCH}>
            </button>
        </div>
    </form>


    <{* ----- List Messages *}>

    <{* Add an ID here *}>
    <form method="post" action="index.php?action=deleteall" id="delete-all-outbox-form">
        <input type="hidden" name="inout" value="out">

        <{foreach item=val from=$ListData}>
        <{* Add unique ID to the container div *}>
        <div id="outbox-item-<{$val.outbox_id}>" class="grid-left mail-list-item">
            <div class="mail-list-author">
                <{* Outbox items are always deletable? If so, no need for disabled state check *}>
                <input type="checkbox" name="delmsg[]" value="<{$val.outbox_id}>">
                <img class="mail-list-avatar" src="<{$val.to_uid|xoops_user_avatarize}>" alt="avatar">
                <{$val.fromname}> <{*- Should this be toname? *}>
            </div>
            <div class="flex-justify">
                <a href="index.php?action=view&amp;inout=out&amp;outbox=<{$val.outbox_id}>" class="mail-list-subject"><{$val.title|truncate:46:"..."}></a>
                <span class="mail-list-date"><{$val.utime|xoops_formattimestamp:l}></span>
            </div>
        </div>
        <{/foreach}>

        <hr>

        <footer class="action-control grid">
            <div>
                <button type="submit" role="button" class="outline secondary delete" name="subbtn" value="<{$smarty.const._DELETE}>">
                    <img class="svg delete" src="<{$xoops_url}>/images/icons/delete.svg" alt="delete"> <{$smarty.const._DELETE}>
                </button>
                <{* Optional: Add a placeholder for notifications *}>
                <span id="delete-outbox-status"></span>
            </div>
            <nav class="pagination" aria-label="pagination"><{xoops_pagenavi pagenavi=$pageNavi}></nav>
        </footer>
    </form>
</article>

<{* Add JavaScript at the end *}>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('delete-all-outbox-form');
    const statusSpan = document.getElementById('delete-outbox-status');

    if (form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Stop normal form submission

            // Get selected message IDs (only checked checkboxes)
            const selectedIds = Array.from(form.querySelectorAll('input[name="delmsg[]"]:checked')).map(cb => cb.value);

            if (selectedIds.length === 0) {
                if (statusSpan) statusSpan.textContent = '<{$smarty.const._MD_MESSAGE_DELETEMSG2|escape:"javascript"}>';
                return; // Don't submit if nothing valid is selected
            }

            // Clear previous status and show deleting message
            if (statusSpan) statusSpan.textContent = 'Deleting...';

            // Fix: Use URLSearchParams instead of FormData for better compatibility
            const params = new URLSearchParams();
            
            // Add each selected ID to the params
            selectedIds.forEach(id => {
                params.append('delmsg[]', id);
            });
            
            // Add the inout parameter
            params.append('inout', 'out');

            // Use fetch with proper content type for form submission
            fetch('index.php?action=deleteall&ajax=1', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params.toString()
            })
            .then(response => {
                // First check if the response is ok before trying to parse JSON
                if (!response.ok) {
                    throw new Error('Server returned ' + response.status + ' ' + response.statusText);
                }
                
                // Try to parse as JSON, but handle text responses too
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // If not JSON, get text and try to parse it
                    return response.text().then(text => {
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            // If parsing fails, return a simple success object
                            console.warn('Response is not valid JSON:', text);
                            return { success: true, message: 'Operation completed' };
                        }
                    });
                }
            })
            .then(data => {
                console.log('Server response:', data); // Debug: log the full response
                
                // Handle both success formats
                if (data.success === true || data.success === 'true' || 
                    (data.deleted_count && data.deleted_count > 0)) {
                    
                    // Success: Remove deleted items from the page
                    if (data.deleted_ids && Array.isArray(data.deleted_ids)) {
                        data.deleted_ids.forEach(id => {
                            const itemToRemove = document.getElementById(`outbox-item-${id}`);
                            if (itemToRemove) {
                                itemToRemove.remove();
                            }
                        });
                    } else if (selectedIds.length > 0) {
                        // Fallback if server didn't return deleted_ids
                        selectedIds.forEach(id => {
                            const itemToRemove = document.getElementById(`outbox-item-${id}`);
                            if (itemToRemove) {
                                itemToRemove.remove();
                            }
                        });
                    }
                    
                    if (statusSpan) statusSpan.textContent = data.message || 'Deleted successfully.';
                    
                    // Check if list is now empty
                    const remainingItems = form.querySelectorAll('.mail-list-item');
                    if (remainingItems.length === 0) {
                        // Show empty outbox message
                        const emptyMessage = document.createElement('p');
                        emptyMessage.textContent = 'Outbox is now empty.';
                        form.parentNode.insertBefore(emptyMessage, form);
                        
                        // Disable delete button
                        const deleteButton = form.querySelector('button[type="submit"]');
                        if (deleteButton) {
                            deleteButton.disabled = true;
                        }
                    }
                } else {
                    // Handle failure
                    console.error('Deletion failed:', data);
                    if (statusSpan) statusSpan.textContent = data.error || 'Deletion failed.';
                }
            })
            .catch(error => {
                console.error('Error during deletion:', error);
                if (statusSpan) statusSpan.textContent = 'Network error during deletion. Please try again.';
            });
        });
    }

    // Enable/disable delete button based on checkbox selection
    const deleteButton = form.querySelector('button[type="submit"]');
    const checkBoxes = form.querySelectorAll('input[name="delmsg[]"]');

    function toggleDeleteButton() {
        const anyChecked = Array.from(checkBoxes).some(cb => cb.checked);
        if (deleteButton) {
            deleteButton.disabled = !anyChecked;
        }
    }

    checkBoxes.forEach(cb => cb.addEventListener('change', toggleDeleteButton));
    toggleDeleteButton(); // Initial check
});
</script>
